---
output:
  html_document:
    css: D:/analysis/R/tistory/plotly/style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 6.5, dpi = 130)
library(showtext)
showtext_auto()
library(tidyverse)
library(readxl)
library(patchwork)
library(plotly)
```

## tqk와 tidyquant 패키지를 사용한 주가 가져오기

데이터 분석이 많이 사용되는 분야 중에 하나가 금융 분야일 것이다. 금융 분야에서는 매우 중요한 것이 리스크 관리이다. 20세기 후반부터 급격히 많이진 다양한 금융 파생 상품의 관리가 복잡해지면서 이 파생 상품을 비롯한 금융권의 다양한 위험을 이를 보다 과학적으로 관리할 필요가 생겼고 이를 수학적, 통계학적, IT적으로 관리하는 방법론으로 유용하게 활용되는 것이 금융 공학이다. 이처럼 수학, 통계, IT 프로그래밍을 기반으로 금융 투자의 가치를 판단하는 사람들을 퀀트(Quantitative Analyst)라고 한다. 

하지만 전문적인 퀀트가 아니라면 복잡한 파생상품들의 분석이 필요없을 것이다. 많은 사람들은 주식에 관심이 많고 주식 분석만 해도 큰 문제는 없을 것이다. 그렇다면 R로 우리나라의 주식 가격을 어떻게 가져올 수 있을까? 이에 대해 알아보겠다. 

### 우리나라 주가 가져오기 : tqk 패키지(출처 : https://github.com/mrchypark/tqk)

`tqk` 패키지는 우리나라의 코스피, 코스닥에 상장된 주가를 가져오는 패키지이다. 이 패키지는 아직(22년 6월) CLAN에 등록되지 못했다. 따라서 Github에 등록된 패키지를 설치해야 한다. 이를 위해서 먼저 `remote` 패키지가 필요하다. 

```{r}
if (!require('tqk')) {
  remotes::install_github("mrchypark/tqk")
  library(tqk)
}

```
`tqk` 패키지에서는 두 개의 함수를 제공한다. 

-   `code_get()` :  한국 주식의 코드를 가져옴
-   `tqk_get()` : 한국 주식 코드에 따른 주식 값을 가져옴

다음과 같이 삼성전자의 주식 코드와 주식값을 가져올 수 있다. 

```{r}
## 먼저 한국 주식의 코드값을 가져온다. 
code <- code_get()

head(code, 10)

## 삼성전자 코드값을 가져온다. 
sse_code <- code |> filter(name == '삼성전자') |>
  select(code) |> 
  pull()

sse_code

samsung <- tqk_get(sse_code, from='2022-01-01', to='2022-06-30')

tail(samsung, 10)
```


### 미국 주가 가져오기 : tidyquant 패키지

이번에는 미국 주식시장에 상장된 주식의 주가를 가져오는 방법을 알아보자. 미국 주가를 가져오는 패키지는 여러개가 있지만 이 중 `tidyverse` 생태계를 사용하는 `tidyquant`를 사용하도록 하겠다. `tidyquant`에서 주가를 가져오는 함수는 `tq_get()`이다. 

`tidyquant`를 사용하여 미국에 상장된 'KT'주가와 다우존스 지수를 가져오는 방법은 다음과 같다. 

```{r}
if (!require('tidyquant')) {
  install.packages("tidyquant")
  library(tidyquant)
}

KT_stock_prices <- tq_get("KT", from='2022-01-01', to='2022-06-30')

KT_stock_prices |> tail(10)

tq_get("DOW", from = "2019-01-01") |> tail(10)

```

`tq_get()`에서 첫 번쨰 매개변수로 사용되는 회사명을 확인하기 위해서는 `tq_exchange()`를 사용할 수 있다. 다만 미국의 주식 시장도 우리나라의 코스피, 코스닥으로 구분되듯이 뉴욕증권거래소(NYSE), 나스닥증권거래소(NASDAQ), 아멕스(AMEX)로 구분되어 있다. 

```{r}
tq_exchange_options()

tq_exchange("NYSE") |> head(10)
```

주가와 관련되어 `tidyquant`에서 제공하는 함수중에 유용한 것이 `tq_index()`이다. 이 함수에 매개변수로 미국에서 사용되는 주가지수를 넣어주면 해당 주가지수를 구성하는 주식의 종류가 리턴된다. 미국 주가의 전반적인 상승과 하락을 측정하기 위해 많이 사용되는 다우존스지수(DOW)는 미국 우량기업 30개의 지수이고 S&P 500 지수는 미국 신용평가사 S&P Global이 미국에 상장된 시가총액 상위 500개 기업의 주식들을 모아 지수로 구성하였다. `tq_index()`에서 검색 가능한 인덱스의 종류는 `tq_index_options()`로 검색된다. 

```{r}
tq_index_options()

tq_index("DOWGLOBAL")

tq_index("DOW")
```


