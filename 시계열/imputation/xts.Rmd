---
output:
  html_document: 
    css: D:/analysis/R/tistory/plotly/style.css
    theme: cerulean
    highlight: zenburn
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 6.5)

library(showtext)
showtext_auto()
library(tidyverse)
library(imputeTS)
library(zoo)
library(xts)

```


이번 포스트에서는 시계열 데이터의 결측치 처리 방법 중 `xts` 클래스에 따라 살펴보도록 하겠다. 

## xts와 zoo 

`xts` 클래스와 `zoo` 클래스는 다른 시계열 클래스와는 달리 특수한 관계에 있다. `xts` 클래스는 `zoo` 클래스의 하위 클래스처럼 동작한다. 따라서 `zoo` 클래스는 부모 클래스, `xts` 클래스는 자식 클래스로 `zoo` 클래스에서 정의된 대부분의 기능을 `xts`클래스로 정의된 데이터에서 사용이 가능하다. 따라서 `xts`와 `zoo` 클래스에서 결측치 처리방법을 알아보겠다. 

먼저 필요한 패키지를 로딩하겠다. 그리고 사용하는 데이터는 Part 1에서 사용한 'tsAirgap' 데이터를 `xts` 클래스 변환하여 사용하도록 하겠다. 

### 데이터 Import

결측치 처리를 위해 사용하는 데이터는 `imputeTS` 패키지에서 제공하는 tsAirgap 데이터 셋을 사용하도록 하겠다. 

```{r eval=FALSE}
if (!require(zoo)) {
  install.packages('zoo')
  library(zoo)
}

if (!require(xts)) {
  install.packages('xts')
  library(xts)
}
```

```{r}
index <- lubridate::date_decimal(as.numeric(time(tsAirgap)))

tsAirgap.xts <- xts(tsAirgap, order.by = as.Date(index))

tsAirgap.xts |> head(10)

tsAirgap.xts |> plot()

```

#### na.locf()

`na.locf()`는 마지막 관측치를 뒤로 옮겨주는 함수이다.(Last Observation Carried Forward)


```{r}
tsAirgap.xts |> na.locf() |> head(10)

tsAirgap.xts |> na.locf() |> plot()

```

위의 결과와 같이 원 데이터에서 NA값이었던 1949-04-02 데이터와 1949-09-01 데이터가 바로 앞의 값으로 채워진 것을 볼 수 있다.

#### na.approx()

`na.approx()`는 결측치의 바로 직전 값과 바로 다음 값을 사용하여 시간에 따른 선형 보간법으로 결측치를 채우는 함수이다. 

```{r}
tsAirgap.xts |> na.approx() |> head(10)

tsAirgap.xts |> na.approx() |> plot()
```

#### na.fill()

`na.fill()`는 결측치를 세가지 부분으로 나누어 채우는 함수이다. `na.fill()`의 매개변수인 'fill'에 세개의 컴포넌트를 가진 벡터나 리스트를 설정할 수 있는데 첫번째 요소는 맨 왼쪽(시계열의 시작점), 두번째 요소는 시계열 내부 데이터(시계열 시작과 마지막을 제외한), 세번쨰 요소는 맨 오른쪽(시계열의 끝점) 데이터를 지정하여 특정한 값을 채워 넣을 수 있다. 이 요소에서 'extend'를 명기하면 특정 값을 넣는 것이 아닌 선형 보간을 통한 보정치를 넣어주고 NULL을 명기하면 결측치를 제거해준다.앞에서 실습에 사용한 'tsAirgap'은 시작점과 마지막점의 데이터가 채워져 있는데 `na.fill()`의 결과를 보기 위해 NA로 채워넣고 시작하겠다. 

```{r}
tsAirgap.xts.fill <- tsAirgap.xts 

tsAirgap.xts.fill[1] <- NA 

tsAirgap.xts.fill[nrow(tsAirgap.xts.fill)] <- NA  

tsAirgap.xts.fill |> head(10)

tsAirgap.xts.fill |> tail(10)

tsAirgap.xts.fill |> plot()

## 결측치 전체를 선형 보간법으로 채움
na.fill(tsAirgap.xts.fill, "extend") |> head(10)

na.fill(tsAirgap.xts.fill, "extend") |> tail(10)

na.fill(tsAirgap.xts.fill, "extend") |> plot()

## 첫번째 시계열 값을 선형 보간법으로 중간값은 1000으로 채우는데 마지막 시계열 값에 대한 설정이 없어 첫번쨰 시계열 설정값인 'extend'를 마지막 시계열 설정값으로 사용
na.fill(tsAirgap.xts.fill, c("extend", 1000)) |> head(10)

na.fill(tsAirgap.xts.fill, c("extend", 1000)) |> tail(10)

na.fill(tsAirgap.xts.fill, c("extend", 1000)) |> plot()

## 첫번째 시계열 값을 1, 중간값들은 모두 300, 마지막 값은 500으로 설정
na.fill(tsAirgap.xts.fill, c(1, 300, 500)) |> head(10)

na.fill(tsAirgap.xts.fill, c(1, 300, 500)) |> tail(10)

na.fill(tsAirgap.xts.fill, c(1, 300, 500)) |> plot()

## 첫번째와 마지막 시계열 값은 NA, 중간값은 모두 제거
na.fill(tsAirgap.xts.fill, list(NA, NULL, NA)) |> head(10)

na.fill(tsAirgap.xts.fill, list(NA, NULL, NA)) |> tail(10)

na.fill(tsAirgap.xts.fill, list(NA, NULL, NA)) |> plot()
```


