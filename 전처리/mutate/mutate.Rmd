---
output:
  html_document:
    css: D:/analysis/R/tistory/plotly/style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 6.5)

library(showtext)
showtext_auto()
library(tidyverse)
library(readxl)
library(patchwork)
library(plotly)
library(sf)

theme_set(theme_bw() +
  theme(text = element_text(size = 25))
)

```

## mutate 파생 함수의 활용

`tidyverse` 생태계에서 사용자를 매료시키는 기능은 뭐니뭐니해도 `dplyr`를 사용한 데이터 전처리의 편리함일 것이다. `dplyr`에서 제공하는 각종 데이터 전처리 함수들은 SQL 언어를 사용하던 유저들은 바로 활용이 가능할 정도로 사용이 쉽다. SQL을 모르는 유저도 매우 쉽게 배우고 사용할 수 있다는 점에서 python에서도 `dplyr`를 유사하게 흉내 낸 패키지까지 등장할 정도로 사용이 쉽다. 

`dplyr`에서 제공하는 데이터 전처리 함수들 중에 새로운 데이터 열을 만들어내는 함수가 `mutate()`함수이다. 대부분의 R 입문서에서도 `mutate()`를 다루고 있지만 `mutate()`에서 파생된 함수들까지 다루는 입문서는 찾아보기 어렵다. 여기서는 `mutate()`의 파생 함수들의 사용법을 알아보겠다. 

`mutate()`는 변수 역할을 하는 새로운 열을 만들어 내는 함수이다. 하지만 하나의 열을 만들어내는데 하나의 산식이 필요하다. 만약 10개의 열을 만들어야 한다면 `mutate()`안에 10개의 열에 대한 수식을 나열해야 한다. 이렇게 많은 열을 만들어야 하는 경우를 위해 `dplyr`에서는 몇 개의 추가적 함수를 제공한다.

### 데이터 import

`mutate()` 파생 함수의 활용 방법을 알아보기 위해 열이 많은 데이터를 가져오도록 하겠다. 사용할 데이터는 '주요-07 (유초)행정구역별 연령별 학생수(1999-2021)_220524y.xlsx'로 [교육통계 서비스 홈페이지](https://kess.kedi.re.kr)의 [시도별 행정구별 연령별 학생수](https://kess.kedi.re.kr/post/6694016?itemCode=04&menuId=m_02_04_03_01) 에서 다운로드 받았다. 

```{r}
df_mutate <- read_xlsx('D:/R/data/주요-07 (유초)행정구역별 연령별 학생수(1999-2021)_220524y.xlsx', sheet = 'Sheet1', 
                       skip = 3, col_names = T, col_type = c(rep('text', 4), rep('numeric', 63)))

colnames(df_mutate) <- c('연도', '시도', '행정구역', '학제', '전체', '남자', '여자', paste0(rep(c('전체', '남자', '여자'), 20), '_', rep(2:21, each = 3), '세'))

glimpse(df_mutate)
```

이 데이터는 열의 수가 총 67개인 데이터이다. 위의 데이터 구조를 보면 알겠지만 각 열은 연령별 전체 학생수, 남자, 여자 학생수를 나타내는데 5번부터 7번째열은 전체 합계에 해당하는 열이다. 이 데이터를 전체에 대한 비율로 바꾸어 보겠다. 

전체에 대한 비율로 바꾸려면 전체 합계에 해당하는 수치로 각 연령별 학생수를 나누어 주어야 한다. 만약 단순히 `mutate()`를 사용해야 한다면 2세부터 21세까지의 전체, 남자, 여자에 해당하는 총 60개의 수식을 나열해야 한다. 이럴경우 대부분 ctrl+c ctrl+v를 사용하여 60개를 복사하고 연령을 나타내는 수를 바꾸어주는 형태로 60개의 수식을 만들것이다. 이러한 작업을 해 본 사람이라면 이 작업이 얼마나 많은 오류를 만들어 낼 수 있는지 알 것이다. 이런 경우에 사용하는 `mutate()` 파생 함수는 다음과 같다.

### mutate_all

`mutate_all()`은 전체 열에 대해 동일한 수식을 적용하는 함수이다. `mutate_all()`에는 모든 열에 적용할 함수를 명기해야 한다. 단순히 평균이나 합계를 내는 경우에는 'mean', 'sum'과 같은 함수명을 매개변수로 전달하면 된다. 하지만 이 `mutate_all()`을 'df_mutate'에 적용시키면 다음과 같은 결과를 낸다. . 

```{r}
df_mutate_all <- df_mutate |> mutate_all(mean)

df_mutate_all |> head(10)
```

위의 결과에서 보면 두 가지 이상한 점이 있다. 첫번째는 연도, 시도 등 문자열을 포함한 열은 NA로 채워져 있고 계산된 수치열은 열별로 모든 행이 같은 값을 가진다는 것이다. 첫 번째 문제는 문자열에 대해서는 평균을 구할수 없기 때문에 발생한 문제이다. 두 번째 문제는 `mutate_all()`의 적용 함수인 'mean'은 열 방향으로 적용되는 함수이기 때문에 같은 열의 모든 행은 같은 값을 가지게 된다는 것이다.  

첫 번째 문제는 다음과 같은 방법으로 해결할 수 있다. 

```{r}
df_mutate_all <- cbind(df_mutate |> select(1:4), 
      df_mutate |> select(-(1:4)) |> mutate_all(mean)
)

df_mutate_all |> head(10)

```

이제 두 번째 문제를 해결해 보자. 앞서 언급한 바와 같이 여기서는 각각의 연령에 해당하는 학생수를 전체로 나누어 비율을 구하는 함수를 만들어야 한다. 여기서는 '전체'에 대해 데이터를 만드는 방법을 사용한다. 


```{r}
df_mutate_all <- cbind(df_mutate |> select(1:4),
       df_mutate |> select(-(1:4)) |>
         select(starts_with('전체')) |>
         mutate_all(list(비율 = ~round(./전체, 3)))
)
       
df_mutate_all |> select(ends_with('비율')) |>
  head(10)

df_mutate_all |> glimpse()


```

`muate_all()`에 `list()`를 사용하여 함수를 만들었다. 이전에는 `funs()`를 사용하여 함수를 만들었지만 `dplyr`에서는 `funs()`를 폐기할 예정으로 `list()`를 사용할 것을 권고하고 있다. `list()`로 새로 만들어질 열 이름과 계산될 수식을 `~`를 붙여 넣어주면 `~`로 묶여진 수식을 함수로 인식하여 계산되는데 `.`은 자신의 열을 의미한다. 따라서 `비율 = ~round(./전체, 3)`은 '비율'이라는 열을 만드는데 '각각의 열(`.`)을 '전체' 열로 나누고 소수점 3자리에서 반올림하는 함수'를 의미한다. 이렇게 계산된 값들은 '비율'이라는 접미어가 붙은 열로 생성되어 저장된다. 

### mutate_at

앞선 `mutate_all()`은 전체 열에 대해 같은 함수를 적용하기 때문에 전체, 남자, 여자를 구분하여 적용할 수 없어서 전체에 해당하는 열만 계산하였다. 하지만 전체, 남자, 여자에 해당하는 열에 각각 적용하려면 어떻게 해야하는가? 이럴때 사용하는 함수가 `mutate_at()`이다. 

`mutate_at()`은 문자열 벡터나 `vars()`에 선택된 열에 해당하는 열에 한하여 설정된 함수를 적용하는 함수이다. 앞서의 경우에는 열 이름이 '전체', '남자', '여자'로 시작하는 열을 따로 따로 적용해야하기 때문에 `muate_at()`을 사용해야 한다. 

```{r}
df_mutate_at <- df_mutate |>
  mutate_at(vars(starts_with('전체')), list(비율 = ~round(./전체, 3))) |>
  mutate_at(vars(starts_with('남자')), list(비율 = ~round(./남자, 3))) |>
  mutate_at(vars(starts_with('여자')), list(비율 = ~round(./여자, 3)))

df_mutate_at |>  select(ends_with('비율')) |>
  head(10)

df_mutate_at |> glimpse()

```

### mutate_if

`mutate_if()`는 특정 조건과 일치하는 모든 변수의 수정을 위해 사용한다. `mutate_if()`는 특정 데이터 타입의 열을 다른 데이터 타입으로 변경할 때 유용하게 사용된다. 만약 앞서 만든 데이터를 모두 문자열로 바꾸어야한다면 `mutate_if()`가 매우 유용하게 사용된다. 

```{r}
df_mutate_if <- df_mutate_at |>
  mutate_if(is.numeric, as.character)

df_mutate_if |>
  head(10)

df_mutate_if |>
  glimpse()

```





