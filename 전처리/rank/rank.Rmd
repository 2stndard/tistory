---
output:
  html_document:
    css: D:/analysis/R/tistory/plotly/style.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.width = 6.5)

library(showtext)
showtext_auto()
library(tidyverse)
library(readxl)
library(patchwork)
library(plotly)
library(sf)

theme_set(theme_bw() +
  theme(text = element_text(size = 25))
)

```

## rank()를 사용한 순위 구하기

데이터 분석에서 자신이 원하는 데이터를 산출하고 나면 대부분 수행하는 것이 어떤 데이터가 가장 좋고 어떤 데이터가 가장 나쁜지를 확인하게 된다. 이 경우 가장 쉽게 사용되는 방법이 원하는 데이터로 정렬하는 방법이다. 하지만 경우에 따라 순위를 명기해야 할 때가 있다. 전체를 대상으로 순위를 산출한다면 전체 데이터를 정렬하고 처음부터 마지막까지 순번을 붙여주면 되지만 그룹화된 데이터에 대한 그룹별 순위를 산출해야 한다면 이 방법은 사용할 수 없다. 이런 경우 사용할 수 있는 함수가 `rank()`이다. 

`rank()`의 사용법을 알아보기 위해 전국 17개 시도의 비정규 교원 1인당 학생수 데이터를 만들어 보겠다. 

### 데이터 import

17개 시도의 비정규 교원 1인당 학생수를 산출하기 위해 교육통계 서비스 홈페이지의 한국교육개발원 교육통계 서비스 홈페이지의 '주제별 공개 데이터' 메뉴 중 '[04] 행정구역별 교육통계 요약_학교수 학생수 입학 졸업 교원 직원 학업중단 다문화 등(1999-2021)'의 <https://kess.kedi.re.kr/post/6731852?itemCode=04&menuId=m_02_04_03_01> '유초 주요-04 시도별 행정구역별 교육통계 현황_방통제외(1999-2021)_20220523y.xlsx'을 사용하였다.  

이 엑셀파일에는 1999년부터 2021년까지의 시도별 학제별 각종 데이터가 들어있는데 연도마다 포맷이 다소 다르기 때문에 sheet에 따라 연도별 데이터가 저장되어 있다. 이 중 2015~2021년까지의 데이터를 다음과 같이 가져오겠다. 

```{r}
df_provinfo_21 <- read_excel('D:/R/data/유초 주요-03 시도별 교육통계 현황_방통포함(1999-2021)_20220523y.xlsx', 
                               sheet = '2021', skip = 11,
                               col_types = c(rep('text', 3), rep('numeric', 170)), 
                               col_names = FALSE)

df_provinfo_1520 <- read_excel('D:/R/data/유초 주요-03 시도별 교육통계 현황_방통포함(1999-2021)_20220523y.xlsx', 
                               sheet = '2015-2020', skip = 12,
                               col_types = c(rep('text', 3), rep('numeric', 138)), 
                               col_names = FALSE)

```


### 데이터 전처리

가져온 데이터 중에 필요한 데이터만 가져오겠다. 여기서 필요한 데이터는 연도, 시도, 학제, 학급수, 학생수, 전체 교원수, 비정규 교원수이다. 이 중 비정규 교원수는 엑셀 파일에 들어있지 않은 데이터이기 때문에 기간제 교원수와 시간강사수를 합쳐서 만들어 내야한다. 또 여러 학제 중 초등학교, 중학교, 고등학교 데이터만 사용하기 위해 다음과 같이 전처리한다. 

```{r}
## 21년 데이터 전처리
df_provinfo_21 <- df_provinfo_21 |> select(1, 2, 3, 15, 25, 73, 112, 115)

colnames(df_provinfo_21) <- c('연도', '시도', '학제', '학급수', '학생수', '전체교원수', '기간제교원수', '시간강사수')

df_provinfo_21 <- df_provinfo_21 |> 
  mutate(비정규교원당학생수 = 학생수 / (기간제교원수 + 시간강사수))

df_비정규교원당학생수_21 <- df_provinfo_21 |> 
  filter(학제 %in% c('초등학교', '중학교', '고등학교'))

## 15~20년 데이터 전처리
df_provinfo_1520 <- df_provinfo_1520 |> select(1, 2, 3, 5, 20, 41, 80, 83)

colnames(df_provinfo_1520) <- c('연도', '시도', '학제', '학급수', '학생수', '전체교원수', '기간제교원수', '시간강사수')

df_provinfo_1520 <- df_provinfo_1520 |> 
  mutate(비정규교원당학생수 = 학생수 / (기간제교원수 + 시간강사수))

df_비정규교원당학생수_1520 <- df_provinfo_1520 |> 
  filter(학제 %in% c('초등학교', '중학교', '고등학교')) |> arrange(연도)

```

이제 두 데이터를 붙이면 15~21년까지의 데이터가 완성된다. 

```{r}
df_비정규교원당학생수 <- rbind(df_비정규교원당학생수_1520, df_비정규교원당학생수_21)

df_비정규교원당학생수 |> head(10)
```

### rank()를 사용한 순위 산출

이제 앞서 전처리한 데이터에 대해 `rank()`를 사용하여 순위를 산출하면 다음과 같다.

```{r}
df_비정규교원당학생수_rank <- df_비정규교원당학생수 |> mutate(rank = rank(비정규교원당학생수))

df_비정규교원당학생수_rank |> arrange(rank)
```

위의 결과를 보면 2021년 부산 고등학교의 비정규 교원 1인당 학생수가 가장 적은 것으로 나타난다. 이와 같이 `rank()`는 순위의 기준이 되는 열에 대해 오름차순의 순위를 산출하여 넣어준다. 

만약 오름차순이 아니라 내림차순으로 순위를 산출하려면 다음과 같이 산출할 수 있다. 

```{r}
df_비정규교원당학생수 |> mutate(rank = rank(-비정규교원당학생수)) |> 
  arrange(rank) |> head(10)

```

### 그룹별 rank()를 사용한 순위 산출

위의 두가지 데이터를 전반적으로 보면 비정규 교원 1인당 학생수가 적은 순위는 대부분 2019~2021년의 고등학교 데이터이고 교원 1인당 학생수가 많은 순위는 연도는 여러 연도에 분포되지만 학제가 초등학교에 집중되어 있다. 이는 연도와 학제에 따라 비정규 교원당 학생수의 범위가 차이가 난다는 것을 알 수 있다. 따라서 연도별, 학제별로 순위를 산출하기 위해서는 `group_by()`와 `rank()`를 같이 사용해야 한다. 

먼저 학제별 비정규 교원 1인당 학생수의 순위는 다음과 같이 구할 수 있다. 

```{r}
df_비정규교원당학생수_rank <- df_비정규교원당학생수 |> group_by(학제) |>
  mutate(rank = rank(비정규교원당학생수))

df_비정규교원당학생수_rank |> arrange(rank) |>
  head(9)
```

위의 데이터를 보면 초등학교 순위는 2021년 경북, 2019년 경기, 2021년 경기의 순서이고 중학교는 2021년 부산, 2021 경북, 2020년 경북의 순이며 고등학교는 2021년 부산, 2021년 경북, 2020년 부산의 순서이다. 

이를 다시 연도별, 학제별 순위를 구한다면 다음과 같다. 

```{r}
df_비정규교원당학생수_rank <- df_비정규교원당학생수 |> group_by(연도, 학제) |>
  mutate(rank = rank(비정규교원당학생수))

df_비정규교원당학생수_rank |> arrange(rank) |>
  filter(rank == 1)
```

각 연도의 학제별 상위 3개의 데이터는 다음과 같다. 

```{r echo = FALSE}
library(knitr)

kable(df_비정규교원당학생수_rank |> filter(rank <= 3) |> arrange(연도, 학제, rank), digits = 2)
```














